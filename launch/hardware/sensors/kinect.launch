<?xml version="1.0"?>

<launch>
    
    <!-- Get the machine file -->
    <arg name="machine" default="localhost"/>
    <include file="$(env ROBOT_BRINGUP_PATH)/machines/$(arg machine).machine" />

    <arg name="name" />

    <!-- Push down all topics/nodelets into "camera" namespace -->
    <group ns="$(arg name)">

        <!-- Nodelet manager --> 
        <node pkg="nodelet" type="nodelet" args="manager" output="screen" machine="$(arg machine)" name="$(arg name)" machine="$(arg machine)"> 
            <rosparam command="load" file="$(env ROBOT_BRINGUP_PATH)/parameters/hardware/sensors/$(arg name)_manager.yaml" />
        </node>

        <!-- Load driver -->
        <node pkg="nodelet" type="nodelet" name="driver" args="load openni_camera/driver $(arg name)" machine="$(arg machine)">
            <rosparam command="load" file="$(env ROBOT_BRINGUP_PATH)/parameters/hardware/sensors/$(arg name)_driver.yaml" />
        </node>

        <!-- Disparity image -->
        <node pkg="nodelet" type="nodelet" name="disparity_depth" args="load depth_image_proc/disparity $(arg name)" machine="$(arg machine)">
            <!-- Use raw image for efficiency -->
            <remap from="left/image_rect" to="depth/image_rect_raw" />
            <remap from="right" to="projector" />
            <remap from="left/disparity" to="depth/disparity" />

            <param name="min_range" value="0.5" />
            <param name="max_range" value="4.0" />
        </node>

        <!-- Registered Disparity image -->
        <node pkg="nodelet" type="nodelet" name="disparity_registered_hw" args="load depth_image_proc/disparity $(arg name)" machine="$(arg machine)">
            <!-- Use raw image for efficiency -->
            <remap from="left/image_rect" to="depth_registered/hw_registered/image_rect_raw" />
            <remap from="right" to="projector" />
            <remap from="left/disparity" to="depth_registered/disparity" />

            <param name="min_range" value="0.5" />
            <param name="max_range" value="4.0" />
        </node>

        <!-- Processing RGB -->

        <!-- Debayered images -->
        <node pkg="nodelet" type="nodelet" name="debayer" args="load image_proc/debayer $(arg name)" machine="$(arg machine)">
            <remap from="image_raw"   to="rgb/image_raw" />
            <remap from="image_mono"  to="rgb/image_mono" />
            <remap from="image_color" to="rgb/image_color" />
        </node>

        <!-- Monochrome rectified image -->
        <node pkg="nodelet" type="nodelet" name="rectify_mono" args="load image_proc/rectify $(arg name)" machine="$(arg machine)">
            <remap from="image_mono" to="rgb/image_mono" />
            <remap from="image_rect" to="rgb/image_rect_mono" />
        </node>

        <!-- Color rectified image -->
        <node pkg="nodelet" type="nodelet" name="rectify_color" args="load image_proc/rectify $(arg name)" machine="$(arg machine)">
            <remap from="image_mono" to="rgb/image_color" />
            <remap from="image_mono" to="rgb/image_raw" />
            <remap from="image_rect" to="rgb/image_rect_color" />
        </node>

        <!-- Rectified image -->
        <node pkg="nodelet" type="nodelet" name="rectify_ir" args="load image_proc/rectify $(arg name)" machine="$(arg machine)">
            <remap from="image_mono" to="ir/image_raw" />
            <remap from="image_rect" to="ir/image_rect_ir" />
        </node>

        <!-- Rectified raw image (internal use) -->
        <node pkg="nodelet" type="nodelet" name="depth_rectify_depth" args="load image_proc/rectify $(arg name)" machine="$(arg machine)">
            <remap from="image_mono"  to="depth/image_raw" />
            <remap from="image_rect"  to="depth/image_rect_raw" />
            <param name="interpolation" value="0" />
        </node>

        <!-- Rectified depth image -->
        <node pkg="nodelet" type="nodelet" name="depth_metric_rect" args="load depth_image_proc/convert_metric $(arg name)" machine="$(arg machine)">
            <remap from="image_raw" to="depth/image_rect_raw" />
            <remap from="image"     to="depth/image_rect" />
        </node>

        <!-- Unrectified depth image -->
        <node pkg="nodelet" type="nodelet" name="depth_metric" args="load depth_image_proc/convert_metric $(arg name)" machine="$(arg machine)">
            <remap from="image_raw" to="depth/image_raw" />
            <remap from="image"     to="depth/image" />
        </node>

        <node pkg="nodelet" type="nodelet" name="depth_registered_rectify_depth" args="load image_proc/rectify $(arg name)" machine="$(arg machine)">
            <remap from="image_mono"  to="depth_registered/image_raw" />
            <remap from="image_rect"  to="depth_registered/hw_registered/image_rect_raw" />
            <param name="interpolation" value="0" />
        </node>

        <!-- RGBD SERVER -->
        <node name="rgbd_encoder" pkg="rgbd" type="rgbd_server" output="screen" machine="$(arg machine)">
            <remap from="cam_info" to="rgb/camera_info"/>
            <remap from="rgb_image" to="rgb/image_color"/>
            <remap from="depth_image" to="depth_registered/image_rect"/>
            <remap from="output" to="top_kinect/rgbd"/>
        </node>

    </group> <!-- camera -->

</launch>
